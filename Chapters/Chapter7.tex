% Chapter Template

\chapter{Results and Discussion} % Main chapter title

\includegraphics[width=\linewidth,trim={0 7cm 0 12cm},clip]{Paradise_Lost_22}

\label{Chapter 7} % Change X to a consecutive number; for referencing this chapter elsewhere, use \ref{ChapterX}

In the following chapter what was achieved over the project will be discussed. This will begin with the challenges encountered during and final state of the matrix mode and secure compartment sections. This will then continue on to discussing the research questions and will end with a discussion about the future works of the project reguarding matrix mode and the secure compartments.

%----------------------------------------------------------------------------------------
%	SECTION 1
%----------------------------------------------------------------------------------------
%% Look back at what was achieved and comment on the research questions. How they were answered, fully yes fully no, partially?

\section{Matrix Mode Operation}

\label{Ch7 Sec1}

When initially starting the project, matrix mode was in a unuseable state. The serial interface with the device was locked after input, only allowing a single character to be read. In addition to the locking, there were several visual issues that inhibited the function of matrix mode. While these issues were corrected over the course of the project, they did come with their own challenges along the way. 

%-----------------------------------
%	SUBSECTION 1
%-----------------------------------
\subsection{New Developer Issue}

\label{Ch7 Sec1 Sub1}

The biggest issue encountered when attempting to correct any of the parts of matrix mode was the lack of comments. This project has multiple developers in it and while some sections are well documented, there are some sections that are not obvious to new developers.\\
In addition to the lack of foundation avaliable, the range of developemnt tools in use in this project requires an advanced knowledge of programming and hardware design. Thoughout this project the design language VHDL was the main language used, but despite this a detailed knowledge was required of Verilog, GS4510 assembly, Vivado tool command language (tcl) and Make. As I had no knowledge of the latter languages this made some sections of the project difficult to design.\\
Despite these challenges changes to the tcl, Make and Assembly files were able to be done and an understanding of the Verilog files was developed.

%-----------------------------------
%	SUBSECTION 2
%-----------------------------------
\subsection{Serial Locking Issues}

\label{Ch7 Sec1 Sub2}

During the correction of the serial locking issue, correcting the offending code proved to be very challenging. As the MEGA65 did not have all the excessive resources of modern devices, after identifying the issue, it was difficult to implement a solution to the problem that was efficient. This lead to brainstorming of possible corrections and their security implications. In the end, the solution that was favoured was the edit code that was already present, adding the minimal amount of my own code. This issue was entirely overcome after implementing the first change to the MEGA65. Upon suggesting my change to Dr. Gardner-Stephen I was informed that any change made should be added to the project. This was as the optimisation of the device had not yet occurred, so any changes I make will inevitably be improved.  

%-----------------------------------
%	SUBSECTION 3
%-----------------------------------
\subsection{Letterboxing}

\label{Ch7 Sec1 Sub3}

During the correction of the visual issues in matrix mode through a letterbox signal, a lack of project knowledge proved to be very tough to overcome. This lack of knowledge resulted in several attempts to correct the issue through offsets and other, ultimately useless, tricks to move the terminal memory around. If a greater knowledge of the other sub-systems in the MEGA65 was possessed then the corrections to the device would have procceeded more rapidly.

%-----------------------------------
%	SUBSECTION 4
%-----------------------------------
\subsection{Visual Bug Chasing}

\label{Ch7 Sec1 Sub4}

During corrections to the visual bugs, the biggest challenges faced were the exposing of signals and understanding of what was happening. While running the hardware, exposure of the signals was difficult due to the limited amount of LEDs on the board. This made identification of some of the bugs slow. To combat this, GHDL, the VHDL simulator was used. This exposed the signals more readily as there were report statement littered through the project, this would make signal tracking trivial. GHDL, unfortunetly, did not provide a graphical display of what was occuring on the hardware, making discrimination of expected behaviour from unexpected behaviour difficult.

%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{Secure Compartment Implementation}

\label{Ch7 Sec2}

\subsection{SD card Fixing}

\label{Ch7 Sec2 Sub1}

Fixing the SD card functions, as described in section \ref{Ch6 Sec2 Sub2}, was where the first major issue in the project was encountered. This was due to the multiple branches of knowledge required to even verify id the SD card was working or not. Firstly, a knowledge of the VHDL files was required, in addition to this, knowledge of where the SD card was saving and reading from was required. This allowed me to understand how reading and writing was occuring. But to check that they were occuring correctly, I needed to understand and use assembly to quiery the CPU through the matrix mode commands. This allowed me to manually write, read and reset the SD card.

\subsection{Hypervisor Trap}

\label{Ch7 Sec2 Sub2}

During the creation of the hypervisor trap for secure mode a communication error occurred between Dr. Gardner-Stephen and I. I believed that the hypervisor traps were all done in hardware, as there were hardware implementations for some hypervisor traps in the CPU. This was not the case, the majority of hypervisor traps were to be executed in software. This miscommunication resulted in a time loss on the project.

\subsection{Secure mode Entry/Exit}

\label{Ch7 Sec2 Sub3}



%----------------------------------------------------------------------------------------
%	SECTION 3
%----------------------------------------------------------------------------------------

\section{Research Question Satisfaction}

\label{Ch7 Sec3}

\textit{What are the missing or non-functional sub-systems that the MEGA65 requires to be implemented?}\\
Over the course of the project, several missing and/or non-functional sub-systems were found within the MEGA65 smart phone. 
Of those sub-systems, the ones that were fixed are detailed in the previous chapters \todo{maybe reference these chapters} of this document. 
Despite the fixes applied, there are still many sub-systems of the phone that require additional attention in order for them to function as intended.\\
One of the functions of the phone is being able to create and load save states that are images of the phone at a particular point in time. 
These save states are mostly functional, but there are still some strange cases, in which, their function causes issues for the user. 
It was noted, but not explored, that creating a save state in the most recent version of the phone causes the partition table to be invalidated. 
This is suspected to be the result of some change to the save state code causing the slot pointer to point to the partition table instead of the desired slot.\\
The save state error also has a cascading effect into the implementation of secure mode, as discussed in chapter \ref{Chapter 6}. 
As described in section \ref{Ch6 Sec3 Sub2}, the secure mode implementation planns to use this save state proccess as a part of it, this error will therefore cause the secure state to corrupt the patition table.\\
In addition to the partition corrupting, the secure mode is also non-functional for a number of other reasons. 
The string comparison seen in figure \ref{fig:monitoracceptreject}, only compares the input to the upper case version of accept or reject. 
While this could be intentional to ensure that the user truely desires the result, by entering reject in lower case an instruction is invoked. 
This is due to the lower case 'r' character being an instructional prefix. 
Another issue with secure mode is when successfully rejection secure compartments, when the SD card has been removed from the device there is currently no protection against reloading.\todo{Fix this sentence}
This causes the secure mode to load from nothing and produces unpredictable results.\\
Although functionality to matrix mode has mostly been restored, it is not working entirely as intended. 
From within matrix mode it is possible to halt and single step the CPU, if the CPU is halted, then a request to leave matrix mode is sent and stepped through, the user is left in user mode with a frozen CPU and no way to return to matrix mode.
When exiting from matrix mode with the secondary exit keycode, superkey + ~, the ~ key is printed in user mode. 
This is believed to be due to double scanning of the non-special input keys.\\
When experimenting with the SD card compatability, it was noted that the SDXC card was not recognised as an SD card at all. Investigation into the SD card hardware showed that there was no case for this type of card. 
In addition to this, in the latest version of the phone, the SD card detecion no longer rescans for the SD card if one is not initially detected.\\
\\
\textit{How can these sub-systems be implemented?}\\
\begin{itemize}
\item{Load and Save Sate}\\
  The save state partition table corruption issue should be solved by reviewing the location at which the save state is attemping to be saved to. 
  This location should be confirmed as save state slot. 
  Additionally, the size of the data being saved should be compared to the size of the save state slot to ensure that other data is not being overwritten.
\item{ACCEPT/REJECT Strings}\\
  To ensure the secure compartment sub-system is functional and in accordance with the user's expectations, the lower case versions of accept and reject should also have the same functionality as the upper case versions. 
  Conversely to this, if the accept and reject cases are restricted to upper case only, inputing a lower case version should send a warning to the user and, in the reject case, not throw a syntax error.
\item{CPU Locking}\\
  To prevent CPU locking and restore some functionality to matrix mode, exiting matrix mode should be tied into unfreezing the CPU.
\item{SD card Protection}\\
  To protect the SD card against loading junk data from the SD card slot when the SD card is removed, a fail state should be implemented when the attempting to load and no SD card is detected. This state should prompt the user to insert an SD card and specify the slot they wish to load from.
\item{SDXC Support}\\
  The SDXC SD cards should have their data sheet evaluated and the functionality required to used them added to the SD card handeling hardware.
\end{itemize}

\textit{How can the simplicity, understandability and hence, the security of these sub-systems be maximised?}\\
When considering how to ensure the simplicity, understandability and security of each sub-system, it was decided that the UNIX philosophy should be employed. "Do one thing and do it well." This was employed in all aspects mentioned in this document. The matrix rain compositor only places the matrix video over the screen. When performing the secure mode proccess, only the secure mode trap is being acted upon, only save state function is occurring, only the user's input is being proccessed, etc. This philosophy removes the obscuration from performing tasks that may otherwise be complex. In addition to this, by using smaller and more simple sub-systems they are inherrantly more easily understood. 
\\
\textit{How can the complete MEGA65 architecture be physically prototyped on the bench?}\\
The MEGA65 architecture is implemented almost entirely on an FPGA device, because of this it is almost trivial to add the required sub-models to the board via headder pin connections.
\\
\textit{How can the secure compartmentalisation's architecture planned for the MEGA65 be realised?}\\
blah
\\


%----------------------------------------------------------------------------------------
%	SECTION 2
%----------------------------------------------------------------------------------------

\section{Future Work}
